# DB 大補貼

{%hackmd SMZ4iEDOTpu6bwSdU4dxJw %}

{%hackmd ngw2d7oGSlalLlMKEirrXA %}

# Window Function

:::info
本章節大量資訊引用自 2021 COSCUP 開源人年會上 John Liu 先生的簡報內容。[MySQL 8 那麼久了，還沒開始用 window function 嗎？ - John Liu](https://coscup.org/2021/zh-TW/session/DZMCHW)
:::

> Window Function 是現代 SQL 很重要的功能，是早在其他 SQL 生態圈行之有年的重要功能。
MySQL 則是在 8.0 終於正式推出這個功能，但似乎還不是很多 MySQL 的使用者知道它的存在，
這個議程會跟大家分享 Window Function 的核心概念與實務操作技巧與經驗，希望能幫助大家早日導入在開發的專案中。

* 一般人使用 Group
  ![Group 示例](https://i.imgur.com/YJ0RBgN.png)
* 視窗仔使用 Window Group
  ![Window 示例](https://i.imgur.com/6UL7Kov.png)


```sql=
SELECT
  year, country, product, profit,
  SUM(profit) OVER() AS total_profit,
  SUM(profit) OVER(PARTITION BY country) country_profit
```

![簡單示意](https://i.imgur.com/vjesWZy.png)

* 主要風格：將程式語言的邏輯，植入 SQL 中
  ![語法結構](https://i.imgur.com/TQwFOsl.png)
* Window Name：類似變數，給某種 Window 一個命名
  WINDOW **xxx** AS(PARTITION BY COL_NAME)
  ![Window Name 結構](https://i.imgur.com/SBCY1mD.png)
* FRAME_CLAUSE：窗格模式
  有點像是累積(前一筆跟後一筆與自己的平均)
  第二筆：1,2,3 的平均
  ![窗格模式_第二筆](https://i.imgur.com/QuWs2XZ.png)
  第三筆：2,3,4 的平均
  ![窗格模式_第三筆](https://i.imgur.com/CSz1Z3e.png)
  * 文法
    ![窗格模式_文法](https://i.imgur.com/Yfq9kdX.png)
    * Frame unit
      * ROWS：按照 row number
      * RANGE：按照 row value
    * Frame extend
      ![Frame extend_文法1](https://i.imgur.com/brPitpG.png)
      ![Frame extend_文法2](https://i.imgur.com/sZasDTj.png)
      * 前後 unit 的量，或是指定 UNBOUNDED(往前無限筆直至頭、往後無限筆直至尾)
  * Example
    * 遞減
      ![遞減](https://i.imgur.com/2IQRtvE.png)
* Example
  ![FIRST_VALUE、LAST_VALUE](https://i.imgur.com/Ute0bGF.png)
* 以較好的效益取代某些關聯子查詢
  ![關聯子查詢](https://i.imgur.com/lnGrfJ5.png)
  ![Window 取代版](https://i.imgur.com/QtIdwXm.png)

# 附錄

## Build

```sql=
CREATE TABLE PROJECTS(
  ID NUMBER(19, 0),
  TITLE VARCHAR2(100 CHAR),
  CATEGORY_ID NUMBER(19, 0),
  FUNDING_GOAL NUMBER(19, 0),
  START_DATE NUMBER(19, 0),
  END_DATE NUMBER(19, 0)
);
CREATE UNIQUE INDEX "PK_PROJECTS" ON "PROJECTS"("ID");
CREATE INDEX "PROJECTS_IX1" ON "PROJECTS"("ID", "CATEGORY_ID");

CREATE TABLE CATEGORIES(
  CATEGORY_ID NUMBER(19, 0),
  CATEGORY VARCHAR2(10 CHAR)
);
CREATE UNIQUE INDEX "PK_CATEGORIES" ON "CATEGORIES"("CATEGORY_ID");

CREATE TABLE USERS(
  USER_ID NUMBER(19, 0),
  NAME VARCHAR2(10 CHAR),
  AGE NUMBER(19, 0)
);
CREATE UNIQUE INDEX "PK_USERS" ON "USERS"("USER_ID");
CREATE INDEX "USERS_IX1" ON "USERS"("USER_ID", "AGE");

CREATE TABLE PLEDGES(
  PLEDGE_ID NUMBER(19, 0),
  AMOUNT NUMBER(19, 0),
  USER_ID NUMBER(19, 0),
  PROJECT_ID NUMBER(19, 0)
);
CREATE UNIQUE INDEX "PK_PLEDGES" ON "PLEDGES"("PLEDGE_ID");
CREATE INDEX "PLEDGES_IX1" ON "PLEDGES"("USER_ID", "PROJECT_ID");

INSERT INTO CATEGORIES(CATEGORY_ID, CATEGORY)
VALUES(1, 'Music');
INSERT INTO CATEGORIES(CATEGORY_ID, CATEGORY)
VALUES(2, 'Books');
INSERT INTO CATEGORIES(CATEGORY_ID, CATEGORY)
VALUES(3, 'Charity');

INSERT INTO PROJECTS(ID, TITLE, CATEGORY_ID, FUNDING_GOAL, START_DATE, END_DATE)
VALUES(1, 'The Best Album Ever, When It Is Done', 1, 1000000, 20130928, 20131028);
INSERT INTO PROJECTS(ID, TITLE, CATEGORY_ID, FUNDING_GOAL, START_DATE, END_DATE)
VALUES(2, 'Seriously The Best Book You Will Ever Read', 2, 1000000, 20130930, 20131023);
INSERT INTO PROJECTS(ID, TITLE, CATEGORY_ID, FUNDING_GOAL, START_DATE, END_DATE)
VALUES(3, 'Feel Like The Best Person Alive Charity', 3, 1000000, 20130929, 20131030);
INSERT INTO PROJECTS(ID, TITLE, CATEGORY_ID, FUNDING_GOAL, START_DATE, END_DATE)
VALUES(4, 'I''m Rich But NEED Money For My Book', 2, 500000, 20131001, 20131101);
INSERT INTO PROJECTS(ID, TITLE, CATEGORY_ID, FUNDING_GOAL, START_DATE, END_DATE)
VALUES(5, 'Great Charity', 3, 100000, 20131101, 20140630);
INSERT INTO PROJECTS(ID, TITLE, CATEGORY_ID, FUNDING_GOAL, START_DATE, END_DATE)
VALUES(6, 'New Album From Your Favorite Band', 1, 50000, 20130930, 20140930);
INSERT INTO PROJECTS(ID, TITLE, CATEGORY_ID, FUNDING_GOAL, START_DATE, END_DATE)
VALUES(7, 'Tom Clancy''s Unfinished Work', 2, 100000, 20131015, 20131225);
INSERT INTO PROJECTS(ID, TITLE, CATEGORY_ID, FUNDING_GOAL, START_DATE, END_DATE)
VALUES(8, 'The New Pickaxe Book', 2, 10000, 20110903, 20120101);
INSERT INTO PROJECTS(ID, TITLE, CATEGORY_ID, FUNDING_GOAL, START_DATE, END_DATE)
VALUES(9, 'Teach Kids To Code', 3, 100000, 20131201, 20141201);
INSERT INTO PROJECTS(ID, TITLE, CATEGORY_ID, FUNDING_GOAL, START_DATE, END_DATE)
VALUES(10, 'Matz''s Heavy Metal Album', 1, 1000000, 20130930, 20131002);

INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(1, 'David', 25);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(2, 'Avi', 29);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(3, 'Greg', 26);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(4, 'Emily', 25);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(5, 'Sonja', 29);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(6, 'Ian', 27);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(7, 'Kyle', 28);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(8, 'Rosie', 30);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(9, 'Raymond', 30);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(10, 'Josh', 27);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(11, 'Margeret', 40);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(12, 'Stephanie', 28);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(13, 'Logan', 23);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(14, 'Manuel', 28);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(15, 'Edina', 28);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(16, 'Scott', 30);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(17, 'John', 28);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(18, 'Spencer', 29);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(19, 'Dan', 24);
INSERT INTO USERS(USER_ID, NAME, AGE)
VALUES(20, 'Jeanne', 25);

INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(1, 5088, 1, 10);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(2, 15440, 2, 1);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(3, 1045, 1, 9);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(4, 250, 2, 9);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(5, 500, 3, 5);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(6, 1504, 4, 3);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(7, 1000, 8, 6);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(8, 2500, 18, 8);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(9, 50000, 10, 5);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(10, 15034, 2, 3);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(11, 4400, 1, 4);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(12, 2500, 2, 9);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(13, 54023, 3, 5);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(14, 45000, 4, 3);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(15, 1600, 8, 6);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(16, 90044, 18, 8);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(17, 1500, 20, 3);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(18, 100400, 1, 4);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(19, 25220, 2, 9);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(20, 152000, 2, 3);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(21, 10123, 14, 4);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(22, 25000, 2, 9);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(23, 5420, 3, 5);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(24, 487000, 4, 3);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(25, 1600, 8, 8);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(26, 9001, 18, 8);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(27, 1500, 20, 8);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(28, 10000, 1, 8);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(29, 20000, 2, 9);
INSERT INTO PLEDGES(PLEDGE_ID, AMOUNT, USER_ID, PROJECT_ID)
VALUES(30, 2500, 2, 8);
```

## SELECT 情境

```sql
-- TABLE SCAN
SELECT * FROM PROJECTS;

-- Index Range SCAN
SELECT * FROM PROJECTS WHERE ID BETWEEN 6 AND 10;

-- Index SCAN
SELECT * FROM PROJECTS WHERE ID = 10 AND CATEGORY_ID = 1;

-- 索引破壞
SELECT * FROM PROJECTS WHERE ID+5 = 15 AND CATEGORY_ID = 1;

-- Index SCAN
SELECT * FROM PROJECTS WHERE ID = 15-5 AND CATEGORY_ID = 1;

-- 最左索引
SELECT * FROM PROJECTS WHERE CATEGORY_ID = 1;

-- INNER JOIN
SELECT p.*
     , c.CATEGORY
FROM PROJECTS p
INNER JOIN CATEGORIES c
ON p.CATEGORY_ID = c.CATEGORY_ID;

-- INNER JOIN BY INDEX
SELECT p.*
     , c.CATEGORY
FROM PROJECTS p
INNER JOIN CATEGORIES c
ON p.CATEGORY_ID = c.CATEGORY_ID
WHERE p.ID = 10;

-- INNER JOIN BY INDEX
SELECT p.*
     , c.CATEGORY
FROM PROJECTS p
INNER JOIN CATEGORIES c
ON p.CATEGORY_ID = c.CATEGORY_ID
WHERE p.ID = 10;

-- 三層 JOIN + GROUP BY
SELECT c.CATEGORY, SUM(pl.AMOUNT)
FROM PROJECTS p
INNER JOIN CATEGORIES c
ON c.CATEGORY_ID = p.CATEGORY_ID
INNER JOIN PLEDGES pl
ON pl.PROJECT_ID = p.ID
WHERE c.CATEGORY = 'Books'
GROUP BY c.CATEGORY;

-- 試試看直接查詢，與把 PROJECTS_IX1 改為 CATEGORY_ID 的查詢，看看差異
SELECT p.*
     , c.CATEGORY
FROM PROJECTS p
INNER JOIN CATEGORIES c
ON p.CATEGORY_ID = c.CATEGORY_ID
WHERE c.CATEGORY_ID = 1;
```